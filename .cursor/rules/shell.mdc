---
description: Shell scripting best practices for smplcli
globs: ["*.sh"]
---

# Shell Best Practices

## Shellcheck Compliance

All shell scripts must pass `shellcheck`. Run `make lint` before committing.

If you need to disable a rule, use inline comments:
```bash
# shellcheck disable=SC2034
UNUSED_VAR="intentionally unused"
```

## Variables

### Always use `local` in functions
```bash
# Good
my_function() {
    local name="$1"
    local result
    result=$(some_command)
}

# Bad - pollutes global scope
my_function() {
    name="$1"
    result=$(some_command)
}
```

### Always quote variables
```bash
# Good
echo "$variable"
command "$arg1" "$arg2"

# Bad - word splitting and glob expansion
echo $variable
command $arg1 $arg2
```

### Use `${var:-default}` for defaults
```bash
local name="${1:-anonymous}"
```

## Error Handling

### Use `set -euo pipefail` in scripts (not sourced files)
```bash
#!/bin/bash
set -euo pipefail
```

Note: `cli.sh` is sourced, not executed, so it cannot use `set -e` globally.

### Check command existence before use
```bash
if ! command -v jq &>/dev/null; then
    echo "jq is required" >&2
    return 1
fi
```

## zsh/bash Compatibility

This project supports both bash and zsh. Key differences:

### Array iteration
```bash
# Works in both
for item in "${array[@]}"; do
    echo "$item"
done
```

### Nullglob (handled in cli.sh)
```bash
# zsh
setopt local_options nullglob 2>/dev/null

# bash  
shopt -s nullglob 2>/dev/null
```

The `2>/dev/null` suppresses errors when the other shell's command fails.

## Testing

- Write tests in `tests/cli.bats` using bats-core
- Mock external commands (deno, npm, make) to avoid dependencies
- Run tests with `make test`

## Formatting

- Use tabs for indentation (configured in .editorconfig)
- Run `make fmt` to auto-format with shfmt
- Run `make fmt-check` to verify formatting
